services:
  # 1. å‘é‡æ•°æ®åº“
  milvus-standalone:
    container_name: milvus-standalone
    # ğŸš€ã€ä¿®æ­£ã€‘å®˜æ–¹ v2.3.x ä¹‹åçš„é•œåƒæ ‡ç­¾ä¸å†å¸¦ -standalone åç¼€
    image: milvusdb/milvus:v2.3.7
    environment:
      ETCD_USE_EMBED: true
      ETCD_DATA_DIR: /var/lib/milvus/etcd
      COMMON_STORAGEPATH: /var/lib/milvus/data
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/milvus:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      start_period: 90s

  # 2. åç«¯æœåŠ¡
  backend:
    build: ./backend
    container_name: rag-backend
    restart: always
    depends_on:
      - milvus-standalone
    environment:
      # åœ¨å®¹å™¨å†…éƒ¨ï¼Œè®¿é—® milvus ä¸èƒ½ç”¨ localhostï¼Œè¦ç”¨æœåŠ¡å
      - MILVUS_URI=http://milvus-standalone:19530
      - API_PORT=8000
      # ğŸš€ è¿™é‡Œè¯»å–å®¿ä¸»æœºç¯å¢ƒå˜é‡ï¼Œè¯·ç¡®ä¿æ ¹ç›®å½•æœ‰ .env æ–‡ä»¶æˆ–åœ¨ç»ˆç«¯ export äº†è¯¥å˜é‡
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY} 
      - DEEPSEEK_BASE_URL=https://api.deepseek.com
    volumes:
      # ğŸš€ æŒ‚è½½æ•°æ®ç›®å½•ï¼šå®¿ä¸»æœº ./data -> å®¹å™¨ /data
      # è¿™æ ·ä½ çš„ SQLite æ•°æ®åº“(sessions.db)å’Œä¸Šä¼ çš„æ–‡ä»¶éƒ½èƒ½æŒä¹…åŒ–ä¿å­˜
      - ./data:/app/../data

  # 3. å‰ç«¯æœåŠ¡
  frontend:
    build: ./frontend
    container_name: rag-frontend
    restart: always
    ports:
      - "80:80" # æµè§ˆå™¨è®¿é—® http://localhost æˆ– http://æœåŠ¡å™¨IP
    depends_on:
      - backend